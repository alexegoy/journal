<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Journal Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ---------- Base / Theme ---------- */
    :root { --bg:#f8fafc; --card:#fff; --muted:#64748b; --text:#0f172a; --accent:#3b82f6; }
    body { font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; padding:14px; background:var(--bg); color:var(--text); transition:background .2s,color .2s;}
    body.dark { --bg:#0f172a; --card:#0f172a; --muted:#cbd5e1; --text:#f1f5f9; --accent:#60a5fa; }

    /* ---------- Topbar (centered month label) ---------- */
    .topbar { display:flex; align-items:center; justify-content:space-between; position:relative; margin-bottom:12px; }
    .topbar .side-btn { position:relative; z-index:2; }
    .title { position:absolute; left:50%; transform:translateX(-50%); text-align:center; pointer-events:none; }
    .title h1 { margin:0; font-size:18px; font-weight:700; }
    .title .month { font-size:13px; color:var(--muted); margin-top:4px; }

    .btn { padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.08); background:var(--card); cursor:pointer; transition:transform .08s, background .08s; color:var(--text); }
    .btn:hover { transform:translateY(-2px); }
    body.dark .btn { border-color: rgba(255,255,255,0.06); color:#f1f5f9; background:#1e293b; border:1px solid rgba(255,255,255,0.12); }
    body.dark .btn:hover { background:#334155; }

    /* ---------- Tabs ---------- */
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab { padding:8px 12px; border-radius:8px; cursor:pointer; background:transparent; border:1px solid transparent; }
    .tab.active { background:var(--card); border-color:rgba(15,23,42,0.06); }
    body.dark .tab.active { border-color: rgba(255,255,255,0.06); }

    /* ---------- Calendar grid ---------- */
    .calendar-container { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .weekday { text-align:center; font-size:12px; color:var(--muted); }
    .day { background:var(--card); border-radius:10px; min-height:94px; padding:8px; box-shadow:0 6px 16px rgba(2,6,23,0.04); display:flex; flex-direction:column; gap:6px; cursor:pointer; transition:0.15s; box-sizing:border-box; }
    .day.empty { background:transparent !important; box-shadow:none !important; pointer-events:none !important; }
    .day.weekend { background:#eef2ff !important; cursor:default !important; pointer-events:none !important; }
    body.dark .day.weekend { background:#2d3b57 !important; }

    /* === Dark mode improvements === */
    body.dark .day {
      background:#1e293b;
      border:1px solid rgba(255,255,255,0.05);
      box-shadow:none;
    }
    body.dark .day:hover { box-shadow:0 0 6px rgba(255,255,255,0.12); transform:scale(1.02); }
    body.dark .pnl.positive { color:#4ade80; }
    body.dark .pnl.negative { color:#f87171; }
    body.dark .day.empty { border:none !important; background:transparent !important; box-shadow:none !important; }

    .day-number { font-weight:700; }
    .pnl { font-weight:700; font-size:13px; text-align:right; margin-top:auto; }
    .pnl.positive { color:#16a34a; }
    .pnl.negative { color:#ef4444; }
    .winrate { font-size:11px; text-align:right; color:var(--muted); }
    .trcount { font-size:12px; text-align:right; color:var(--muted); }

    /* ---------- Stats ---------- */
    .stats { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; background:var(--card); padding:10px; border-radius:12px; align-items:center; }
    .stat { min-width:120px; }
    .stat-label { font-size:12px; color:var(--muted); }
    .stat-value { font-weight:700; font-size:14px; }

    /* ---------- Modals / Sheets ---------- */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.45); z-index:1200; padding:16px; }
    .modal.show { display:flex; }
    .sheet { width:100%; max-width:520px; background:var(--card); border-radius:14px; padding:18px; box-shadow:0 18px 40px rgba(2,6,23,0.2); max-height:86vh; overflow:auto; color:var(--text); }
    body.dark .sheet { background:#1e293b; box-shadow:0 12px 30px rgba(2,6,23,0.6); }

    .sheet input, .sheet select, .sheet textarea {
      width:100%; max-width:420px; margin:0 auto 10px; padding:10px 12px; border-radius:10px; border:1px solid rgba(15,23,42,0.08); font-size:14px; display:block; box-sizing:border-box;
    }
    body.dark .sheet input, body.dark .sheet select, body.dark .sheet textarea {
      border-color:rgba(255,255,255,0.15);
      background:#0f172a;
      color:#f1f5f9;
    }
    body.dark .sheet input::placeholder, body.dark .sheet textarea::placeholder { color:rgba(255,255,255,0.6); }

    #resultBtns { display:flex; gap:8px; max-width:420px; margin:0 auto 10px; }
    .btn.result { flex:1; border-radius:20px; border:1px solid rgba(15,23,42,0.08); background:transparent; color:var(--muted); padding:8px 12px; }
    .btn.result.active { color:white; }

    body.dark .btn.result { border:1px solid rgba(255,255,255,0.12); background:#1e293b; color:var(--muted); }
    body.dark .btn.result.active[data-result="win"] { background:#22c55e; border-color:#22c55e; color:#fff; }
    body.dark .btn.result.active[data-result="loss"] { background:#ef4444; border-color:#ef4444; color:#fff; }
    body.dark .btn.result.active[data-result="be"] { background:#3b82f6; border-color:#3b82f6; color:#fff; }

    .daily-summary { padding:10px; border-radius:10px; text-align:center; font-weight:700; max-width:420px; margin:8px auto; }
    .daily-summary.profit { background:#dcfce7; color:#166534; }
    .daily-summary.loss { background:#fee2e2; color:#991b1b; }
    .daily-summary.neutral { background:#e0f2fe; color:#075985; }
    body.dark .daily-summary.profit { background:#14532d; color:#22c55e; }
    body.dark .daily-summary.loss { background:#7f1d1d; color:#ef4444; }
    body.dark .daily-summary.neutral { background:#1e3a8a; color:#3b82f6; }

    .trade-row { background:#f8fafc; border-radius:10px; padding:8px; margin-bottom:8px; font-size:14px; }
    body.dark .trade-row { background:#112233; }

    .trade-actions { display:flex; gap:8px; margin-top:8px; }

    /* ---------- Weekly card colors ---------- */
    .weekly-card { cursor:pointer; border-radius:10px; padding:10px; margin-bottom:8px; }
    .weekly-card.profit { background:#dcfce7; color:#166534; }
    .weekly-card.loss { background:#fee2e2; color:#991b1b; }
    .weekly-card.neutral { background:#e0f2fe; color:#075985; }
    body.dark .weekly-card.profit { background:#14532d; color:#bbf7d0; }
    body.dark .weekly-card.loss { background:#7f1d1d; color:#fecaca; }
    body.dark .weekly-card.neutral { background:#1e3a8a; color:#bfdbfe; }

    /* progress bar */
    .progress-outer { background: rgba(0,0,0,0.06); border-radius:8px; height:12px; width:100%; overflow:hidden; margin-top:8px; }
    .progress-inner { height:100%; border-radius:8px; transition:width .3s ease; }

    /* ---------- Charts (2x2 grid) ---------- */
    .charts-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .chart-card { background:var(--card); padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(2,6,23,0.06); display:flex; flex-direction:column; }
    /* fix aspect ratio consistency */
    .chart-card .canvas-wrap { flex:1; display:flex; align-items:center; justify-content:center; }
    canvas { width:100% !important; height:220px !important; max-height:260px; }

    /* ---------- Misc ---------- */
    .muted { color:var(--muted); font-size:13px; }
    hr { border:none; border-top:1px solid rgba(15,23,42,0.06); margin:12px 0; }
    body.dark hr { border-top-color: rgba(255,255,255,0.04); }

    #toast { position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#16a34a; color:white; padding:8px 12px; border-radius:8px; display:none; z-index:1300; }
    .hidden-file { display:none; }
    .small-muted { font-size:12px; color:var(--muted); }
    .center-row { display:flex; align-items:center; justify-content:center; gap:8px; }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <button class="btn side-btn" onclick="prevMonth()">◀</button>

    <div class="title">
      <h1>Trading Journal Pro</h1>
      <div id="monthLabel" class="month muted"></div>
    </div>

    <button class="btn side-btn" onclick="nextMonth()">▶</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div id="tabJournal" class="tab active" onclick="switchTab('journal')">Journal</div>
    <div id="tabCharts" class="tab" onclick="switchTab('charts')">Charts</div>
  </div>

  <!-- Journal tab -->
  <div id="journalTab">
    <!-- Weekday headers -->
    <div class="calendar-container" id="weekdays"></div>

    <!-- Calendar grid -->
    <div class="calendar-container" id="calendar"></div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat"><div class="stat-label">Monthly P&L</div><div id="totalPnl" class="stat-value">0.00</div></div>
      <div class="stat"><div class="stat-label">Trades</div><div id="totalTrades" class="stat-value">0</div></div>
      <div class="stat"><div class="stat-label">Wins</div><div id="wins" class="stat-value">0</div></div>
      <div class="stat"><div class="stat-label">Losses</div><div id="losses" class="stat-value">0</div></div>
      <div class="stat"><div class="stat-label">Win Rate</div><div id="winRate" class="stat-value">0%</div></div>

      <!-- New analytics -->
      <div class="stat"><div class="stat-label">Max Drawdown</div><div id="maxDrawdown" class="stat-value">0.00</div></div>
      <div class="stat"><div class="stat-label">Profit Factor</div><div id="profitFactor" class="stat-value">0.00</div></div>
      <div class="stat"><div class="stat-label">Longest Win Streak</div><div id="winStreak" class="stat-value">0</div></div>
      <div class="stat"><div class="stat-label">Longest Loss Streak</div><div id="lossStreak" class="stat-value">0</div></div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button class="btn" onclick="toggleDarkMode()">🌙</button>
        <button class="btn" onclick="exportCSV()">⇩ CSV</button>
        <button class="btn" onclick="exportJSON()">⇩ JSON</button>
        <button class="btn" onclick="document.getElementById('importJson').click()">⇪ Import JSON</button>
        <input id="importJson" type="file" accept="application/json" class="hidden-file" onchange="importJSON(this)" />
      </div>
    </div>

    <!-- Weekly performance -->
    <h3 style="margin-top:18px;">📈 Weekly Performance</h3>
    <div id="weeklyStats"></div>

    <!-- DAILY modal (Add/Edit trades) -->
    <div class="modal" id="modal" aria-hidden="true">
      <div class="sheet" role="dialog" aria-modal="true">
        <h3 id="modalDate">Date</h3>

        <select id="symbolSelect" aria-label="Favorite symbols"></select>
        <input id="inputSymbol" placeholder="Or type custom symbol (e.g. XAUUSD)" autocomplete="off" />

        <input id="inputPnl" type="number" placeholder="P&L" step="0.01" />

        <!-- Source selection -->
        <div style="max-width:420px;margin:6px auto;display:flex;gap:8px;align-items:center;">
          <select id="inputSourceType" onchange="onSourceTypeChange()" style="flex:1;">
            <option value="Self">Self</option>
            <option value="Signal">Signal</option>
          </select>
          <select id="inputSourceProvider" style="flex:2; display:none;">
            <option value="">--Select Signal Provider--</option>
            <option>School of Trades (Boss Eddy)</option>
            <option>RevoGold (Ray)</option>
            <option>CallistoFX (Nick)</option>
            <option>TheForexSupport (Casper)</option>
            <option>TradingCartel (Cartel)</option>
          </select>
        </div>

        <div id="resultBtns">
          <button class="btn result" data-result="win">Win</button>
          <button class="btn result" data-result="loss">Loss</button>
          <button class="btn result" data-result="be">Break-even</button>
        </div>

        <textarea id="inputNotes" placeholder="Notes..." rows="3"></textarea>

        <div style="display:flex;gap:8px;max-width:420px;margin:0 auto 8px;">
          <button class="btn" style="flex:1" onclick="saveTrade()">💾 Save</button>
          <button class="btn" style="flex:1" onclick="closeModal()">✖ Close</button>
        </div>

        <div class="favorites-box" style="max-width:420px;margin:0 auto 10px;">
          <button class="btn" style="width:100%" onclick="toggleFavoritesManager()">⚙ Manage Favorites</button>
        </div>

        <div class="favorites-box" id="favoritesBox" style="display:none;">
          <input id="newFavorite" placeholder="Add new favorite symbol (e.g. GBPJPY)" />
          <div style="display:flex;gap:8px;margin:8px 0 12px;">
            <button class="btn" onclick="addFavorite()">Add</button>
            <button class="btn" onclick="toggleFavoritesManager()">Close</button>
          </div>
          <div id="favoritesList"></div>
        </div>

        <div id="dailySummary" class="daily-summary neutral">No trades yet.</div>

        <hr />

        <div id="tradeList"></div>
      </div>
    </div>

    <!-- WEEKLY modal -->
    <div class="modal" id="weeklyModal" aria-hidden="true">
      <div class="sheet" role="dialog" aria-modal="true">
        <h3 id="weeklyModalTitle">Weekly Trades</h3>
        <div id="weeklySummary" class="daily-summary neutral"></div>

        <!-- Goal + Starting capital in modal (editable per-week) -->
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;max-width:420px;margin:8px auto;">
          <div style="flex:1">
            <div class="stat-label">Weekly Goal (amount)</div>
            <input id="weeklyGoalInput" placeholder="e.g. 500" type="number" step="0.01" />
          </div>
          <div style="flex:1">
            <div class="stat-label">Starting Capital</div>
            <input id="weeklyCapitalInput" type="number" placeholder="e.g. 10000" step="0.01" />
          </div>
        </div>
        <div style="max-width:420px;margin:6px auto;display:flex;gap:8px;">
          <button class="btn" onclick="saveWeeklyGoal()">Save Goal</button>
          <button class="btn" onclick="saveWeeklyCapital()">Save Capital</button>
        </div>

        <hr />
        <div id="weeklyTradeList"></div>

        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn" style="flex:1" onclick="generateGeminiWeeklyReport()">🤖 Gemini: Weekly Report</button>
          <button class="btn" style="flex:1" onclick="generateGeminiGoalAnalysis()">🤖 Gemini: Goal Analysis</button>
        </div>

        <div id="aiWeeklyReport" style="margin-top:12px; font-size:14px; line-height:1.5;"></div>

        <button class="btn" style="margin-top:12px;width:100%" onclick="closeWeeklyModal()">✖ Close</button>
      </div>
    </div>

    <div id="toast"></div>
  </div>

  <!-- Charts tab -->
  <div id="chartsTab" style="display:none">
    <h3>Charts (View only)</h3>
    <div class="charts-grid">
      <div class="chart-card">
        <h4>Equity Curve (Cumulative P&L)</h4>
        <div class="canvas-wrap"><canvas id="equityChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h4>Results Distribution</h4>
        <div class="canvas-wrap"><canvas id="pieChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h4>PnL Histogram</h4>
        <div class="canvas-wrap"><canvas id="histChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h4>Source Distribution</h4>
        <div class="canvas-wrap"><canvas id="sourceChart"></canvas></div>
      </div>
    </div>
    <div style="margin-top:12px;" class="muted">Charts update live as you add / edit / delete trades. Journal tab remains default.</div>
  </div>

<script>
/* ================= Data / State ================= */
const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const WEEKDAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

let trades = JSON.parse(localStorage.getItem("journal") || "[]");
let favorites = JSON.parse(localStorage.getItem("favorites") || '["BTCUSDT","ETHUSDT","EURUSD","XAUUSD","GBPJPY"]');
let weeklyCapital = JSON.parse(localStorage.getItem("weeklyCapital") || "{}"); // per-week starting capital (by weekKey)
let weeklyGoals = JSON.parse(localStorage.getItem("weeklyGoals") || "{}"); // per-week goal amount (by weekKey)

let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();

let selectedDate = null;
let selectedResult = null;
let editingId = null;

// store week range for Gemini (used by modal Generate button)
let currentWeekRange = { start: null, end: null, summary: "", weekKey: null };

// Charts instances
let equityChart = null;
let pieChart = null;
let histChart = null;
let sourceChart = null;

/* ================= Helpers: local date strings ================= */
function pad(n){ return String(n).padStart(2,"0"); }
function formatDateLocal(d){
  if(!d) return "";
  if(typeof d === "string") return d;
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function mondayOfWeekLocal(d){
  const tmp = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = tmp.getDay(); // 0..6 (Sun..Sat)
  const diffToMonday = (day === 0 ? -6 : 1) - day;
  tmp.setDate(tmp.getDate() + diffToMonday);
  return tmp;
}
function sundayOfWeekLocal(d){
  const monday = mondayOfWeekLocal(d);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate()+6);
  return sunday;
}

/* ================= Tabs ================= */
function switchTab(name){
  document.getElementById("journalTab").style.display = name === "journal" ? "" : "none";
  document.getElementById("chartsTab").style.display = name === "charts" ? "" : "none";
  document.getElementById("tabJournal").classList.toggle("active", name === "journal");
  document.getElementById("tabCharts").classList.toggle("active", name === "charts");
  if(name === "charts") renderCharts();
}

/* ================= Calendar rendering ================= */
function renderWeekdays(){
  const el = document.getElementById("weekdays");
  el.innerHTML = WEEKDAYS.map(d => `<div class="weekday">${d}</div>`).join("");
}

function renderCalendar() {
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  document.getElementById("monthLabel").innerText =
    MONTHS[currentMonth] + " " + currentYear;

  const firstDow = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (let i = 0; i < firstDow; i++) {
    cal.innerHTML += "<div class='day empty'></div>";
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
    const dayTrades = trades.filter((t) => t.date === key);
    const pnl = dayTrades.reduce((a, t) => a + Number(t.pnl), 0);
    const wins = dayTrades.filter((t) => t.result === "win").length;
    const nonBeTrades = dayTrades.filter(t => t.result !== "be").length;
    const rate = nonBeTrades ? Math.round((wins / nonBeTrades) * 100) : 0;
    const dow = new Date(currentYear, currentMonth, d).getDay();

    const weekendClass = (dow === 0 || dow === 6) ? "weekend" : "";

    // show PnL only if there are trades that day (prevents 0.00 on empty days)
    const pnlText = dayTrades.length ? ((pnl>0?"+":"") + pnl.toFixed(2)) : "";

    const winrateText = nonBeTrades ? rate + "% WR" : "";
    const trcountText = dayTrades.length ? dayTrades.length + " trade" + (dayTrades.length>1 ? "s" : "") : "";

    // Only attach onclick if not weekend
    const click = (dow === 0 || dow === 6) ? "" : `onclick="openModal('${key}')"`;

    cal.innerHTML += `
      <div class="day ${weekendClass}" ${click}>
        <div class="day-number">${d}</div>
        <div class="pnl ${pnl > 0 ? "positive" : pnl < 0 ? "negative" : ""}">${pnlText}</div>
        <div class="winrate">${winrateText}</div>
        <div class="trcount">${trcountText}</div>
      </div>
    `;
  }
  renderStats();
  renderWeeklyStats();
  // update charts live
  renderCharts();
}

/* ================= Monthly stats (extended) ================= */
function renderStats(){
  const monthTrades = trades.filter(t => {
    const d = new Date(t.date + "T00:00:00");
    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
  });
  const pnl = monthTrades.reduce((a,t) => a + Number(t.pnl), 0);
  const wins = monthTrades.filter(t => t.result === "win").length;
  const losses = monthTrades.filter(t => t.result === "loss").length;
  const nonBeTrades = monthTrades.filter(t => t.result !== "be").length;
  const rate = nonBeTrades ? Math.round(wins/nonBeTrades*100) : 0;

  document.getElementById("totalPnl").innerText = pnl.toFixed(2);
  document.getElementById("totalTrades").innerText = monthTrades.length;
  document.getElementById("wins").innerText = wins;
  document.getElementById("losses").innerText = losses;
  document.getElementById("winRate").innerText = rate + "%";

  // Additional analytics for the entire dataset (not only month)
  const overall = computeAnalytics(trades);
  document.getElementById("maxDrawdown").innerText = overall.maxDrawdown.toFixed(2);
  document.getElementById("profitFactor").innerText = overall.profitFactor === Infinity ? "∞" : overall.profitFactor.toFixed(2);
  document.getElementById("winStreak").innerText = overall.longestWinStreak;
  document.getElementById("lossStreak").innerText = overall.longestLossStreak;
}

/* ================= Weekly aggregation & cards ================= */
function getWeekNumber(d){
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = dt.getUTCDay() || 7;
  dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((dt - yearStart)/86400000) + 1)/7);
  return [dt.getUTCFullYear(), weekNo];
}

function calculateWeeklyStats(){
  const weekly = {};
  trades.forEach(t => {
    const d = new Date(t.date + "T00:00:00");
    const [year, week] = getWeekNumber(d);
    const key = `${year}-W${String(week).padStart(2,"0")}`;

    if(!weekly[key]){
      const mon = mondayOfWeekLocal(d);
      const sun = sundayOfWeekLocal(d);
      weekly[key] = { pnl:0, trades:0, wins:0, losses:0, breakeven:0, start: mon, end: sun };
    }

    weekly[key].pnl += Number(t.pnl);
    weekly[key].trades++;
    if(t.result === "win") weekly[key].wins++;
    if(t.result === "loss") weekly[key].losses++;
    if(t.result === "be") weekly[key].breakeven++;
  });
  return weekly;
}

function renderWeeklyStats(){
  const box = document.getElementById("weeklyStats");
  box.innerHTML = "";
  const weekly = calculateWeeklyStats();
  const keys = Object.keys(weekly).sort().reverse(); // newest first
  if(keys.length === 0){
    box.innerHTML = `<p class="muted">No weekly data yet.</p>`;
    return;
  }

  keys.forEach(k => {
    const w = weekly[k];
    const nonBeTrades = w.wins + w.losses;
    const rate = nonBeTrades ? Math.round(w.wins / nonBeTrades * 100) : 0;
    const start = formatDateLocal(w.start);
    const end = formatDateLocal(w.end);
    const pnlText = (w.pnl>0 ? "+" : "") + w.pnl.toFixed(2);
    let cls = "neutral";
    if(w.pnl > 0) cls = "profit";
    else if(w.pnl < 0) cls = "loss";

    // Weekly capital & ROI
    const cap = Number(weeklyCapital[k] || 0);
    const roi = cap > 0 ? (w.pnl / cap) * 100 : null;
    const roiText = roi !== null ? ` • ROI ${roi.toFixed(1)}%` : "";

    // Goal & progress (per-week goal saved in weeklyGoals)
    const goal = Number(weeklyGoals[k] || 0);
    let pct = 0;
    if(goal > 0){
      // percent of goal achieved (clamped to 100)
      pct = Math.min(100, Math.round((w.pnl / goal) * 100));
      if(pct < 0) pct = 0;
    } else {
      // if no goal set, show amount-style behavior: 100 if positive
      pct = w.pnl > 0 ? 100 : 0;
    }

    // progress color logic:
    // - red if pnl < 0
    // - blue if pnl > 0 and < goal
    // - green if pnl >= goal
    let progressColor = "#d1d5db"; // neutral gray
    if(w.pnl < 0) progressColor = "#ef4444"; // red
    else if(goal > 0 && w.pnl >= goal) progressColor = "#16a34a"; // green
    else if(w.pnl > 0) progressColor = "#3b82f6"; // blue

    const capText = cap ? ` • Start: ${cap.toFixed(2)}` : "";

    box.innerHTML += `
      <div class="weekly-card ${cls}" onclick="openWeeklyModal('${k}','${start}','${end}','${encodeURIComponent(`Weekly P&L: ${pnlText} | WinRate: ${rate}%`)}')">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <b>${k}</b>
            <div class="muted" style="margin-top:6px">${start} → ${end}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${pnlText}</div>
            <div class="muted" style="margin-top:6px">${w.trades} trades • ${w.wins} wins • ${w.losses} losses • ${w.breakeven} BE • ${rate}% WR${roiText}${capText}</div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="small-muted">Progress to weekly goal (${goal || "N/A"}): ${pct}%</div>
          <div class="progress-outer">
            <div class="progress-inner" style="width:${pct}%; background:${progressColor};"></div>
          </div>
        </div>
      </div>
    `;
  });
}

/* ================= Weekly modal ================= */
function getWeeklyTradesByStrings(startStr, endStr){
  const s = formatDateLocal(startStr);
  const e = formatDateLocal(endStr);
  return trades.filter(t => t.date >= s && t.date <= e);
}

function openWeeklyModal(weekKey, weekStartStr, weekEndStr, shortEsc){
  const shortSummary = shortEsc ? decodeURIComponent(shortEsc) : `Weekly ${weekKey}`;

  let weeklyTrades = [];
  let startStr = weekStartStr || "";
  let endStr   = weekEndStr || "";

  if(startStr && endStr){
    weeklyTrades = getWeeklyTradesByStrings(startStr, endStr);
  } else {
    // fallback: compute by ISO week
    const [y,w] = weekKey.split("-W");
    weeklyTrades = trades.filter(t => {
      const d = new Date(t.date + "T00:00:00");
      const [yy, ww] = getWeekNumber(d);
      return String(yy) === y && String(ww).padStart(2,"0") === w;
    });
    // derive start/end
    if(weeklyTrades.length){
      const any = new Date(weeklyTrades[0].date+"T00:00:00");
      startStr = formatDateLocal(mondayOfWeekLocal(any));
      endStr   = formatDateLocal(sundayOfWeekLocal(any));
    } else {
      const any = new Date();
      startStr = formatDateLocal(mondayOfWeekLocal(any));
      endStr   = formatDateLocal(sundayOfWeekLocal(any));
    }
  }

  const pnl = weeklyTrades.reduce((a,t)=>a+Number(t.pnl),0);
  const wins = weeklyTrades.filter(t=>t.result==="win").length;
  const losses = weeklyTrades.filter(t=>t.result==="loss").length;
  const be = weeklyTrades.filter(t=>t.result==="be").length;
  const nonBeTrades = wins + losses;
  const rate = nonBeTrades ? Math.round(wins/nonBeTrades*100) : 0;
  const pnlClass = pnl > 0 ? "profit" : (pnl < 0 ? "loss" : "neutral");

  // Prefill capital and goal input for this week
  const cap = Number(weeklyCapital[weekKey] || 0);
  const goal = Number(weeklyGoals[weekKey] || 0);

  const capEl = document.getElementById("weeklyCapitalInput");
  const goalEl = document.getElementById("weeklyGoalInput");
  if(capEl) capEl.value = cap ? String(cap) : "";
  if(goalEl) goalEl.value = goal ? String(goal) : "";

  // ROI if capital provided
  const roi = cap > 0 ? (pnl / cap) * 100 : null;
  const roiBadge = roi !== null ? ` • ROI: <b>${roi.toFixed(1)}%</b>` : "";

  const summaryEl = document.getElementById("weeklySummary");
  if(summaryEl){
    summaryEl.className = "daily-summary " + pnlClass;
    summaryEl.innerHTML = `<b>${weeklyTrades.length} trade(s)</b> • Total P&L: <b>${pnl>=0?"+":""}${pnl.toFixed(2)}</b> • Win Rate: <b>${rate}%</b>${roiBadge}`;
  }

  const list = document.getElementById("weeklyTradeList");
  if(list){
    list.innerHTML = "";
    if(weeklyTrades.length === 0){
      list.innerHTML = `<p class="muted">No trades this week.</p>`;
    } else {
      weeklyTrades.sort((a, b) => a.date.localeCompare(b.date));
      weeklyTrades.forEach(t => {
        list.innerHTML += `<div class="trade-row"><div class="trade-info">${t.date} • ${t.symbol} • ${t.result.toUpperCase()} • ${t.pnl>=0?"+":""}${Number(t.pnl).toFixed(2)} • <span class="small-muted">${t.source||"Self"}</span></div><div class="muted" style="margin-top:6px">${t.notes||""}</div></div>`;
      });
    }
  }

  const title = document.getElementById("weeklyModalTitle");
  if(title) title.innerText = `${weekKey}  (${startStr} → ${endStr})`;
  const modal = document.getElementById("weeklyModal");
  if(modal) modal.classList.add("show");

  currentWeekRange.start = startStr;
  currentWeekRange.end = endStr;
  currentWeekRange.summary = shortSummary;
  currentWeekRange.weekKey = weekKey;

  const aiEl = document.getElementById("aiWeeklyReport");
  if(aiEl) aiEl.innerHTML = "";
}
function closeWeeklyModal(){ const m = document.getElementById("weeklyModal"); if(m) m.classList.remove("show"); }

/* ================= Save weekly capital & goals ================= */
function saveWeeklyCapital(){
  const wk = currentWeekRange.weekKey;
  if(!wk){
    showToast("Open a weekly modal first");
    return;
  }
  const val = parseFloat(document.getElementById("weeklyCapitalInput").value || "0");
  if(isNaN(val) || val < 0){ showToast("Enter a valid capital"); return; }
  weeklyCapital[wk] = val;
  localStorage.setItem("weeklyCapital", JSON.stringify(weeklyCapital));
  showToast("Starting capital saved");
  renderWeeklyStats();
  // update modal summary
  openWeeklyModal(wk, currentWeekRange.start, currentWeekRange.end, encodeURIComponent(currentWeekRange.summary));
}

function saveWeeklyGoal(){
  const wk = currentWeekRange.weekKey;
  if(!wk){
    showToast("Open a weekly modal first");
    return;
  }
  const val = parseFloat(document.getElementById("weeklyGoalInput").value || "0");
  if(isNaN(val) || val < 0){ showToast("Enter valid weekly goal"); return; }
  weeklyGoals[wk] = val;
  localStorage.setItem("weeklyGoals", JSON.stringify(weeklyGoals));
  showToast("Weekly goal saved");
  renderWeeklyStats();
  // refresh modal
  openWeeklyModal(wk, currentWeekRange.start, currentWeekRange.end, encodeURIComponent(currentWeekRange.summary));
}

/* ================= Favorites ================= */
function renderFavoritesDropdown(){
  const sel = document.getElementById("symbolSelect");
  if(!sel) return;
  sel.innerHTML = `<option value="">--Select Symbol--</option>` + favorites.map(f => `<option value="${f}">${f}</option>`).join("");
}

function renderFavoritesList(){
  const box = document.getElementById("favoritesList");
  if(!box) return;
  box.innerHTML = "";
  favorites.forEach((f,i) => {
    const div = document.createElement("div");
    div.className = "favorite-item";
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    div.style.marginBottom = "8px";
    div.innerHTML = `<div>${f}</div><div><button class="btn" onclick="removeFavorite(${i})">Remove</button></div>`;
    box.appendChild(div);
  });
}

function toggleFavoritesManager(){
  const fb = document.getElementById("favoritesBox");
  if(!fb) return;
  fb.style.display = (fb.style.display === "block") ? "none" : "block";
  renderFavoritesList();
}

function addFavorite(){
  const el = document.getElementById("newFavorite");
  if(!el) return;
  const v = (el.value || "").trim().toUpperCase();
  if(!v) return;
  if(!favorites.includes(v)){
    favorites.push(v);
    localStorage.setItem("favorites", JSON.stringify(favorites));
    renderFavoritesDropdown();
    renderFavoritesList();
    showToast("Favorite added");
  } else {
    showToast("Already in favorites");
  }
  el.value = "";
}

function removeFavorite(i){
  if(i<0 || i>=favorites.length) return;
  favorites.splice(i,1);
  localStorage.setItem("favorites", JSON.stringify(favorites));
  renderFavoritesDropdown();
  renderFavoritesList();
  showToast("Favorite removed");
}

/* ================= Daily modal / trade CRUD ================= */
function onSourceTypeChange(){
  const t = document.getElementById("inputSourceType");
  const p = document.getElementById("inputSourceProvider");
  if(!t || !p) return;
  if(t.value === "Signal") p.style.display = "block";
  else { p.style.display = "none"; p.value = ""; }
}

function openModal(date){
  selectedDate = date;
  selectedResult = null;
  editingId = null;
  const md = document.getElementById("modalDate");
  if(md) md.innerText = date;
  const modal = document.getElementById("modal");
  if(modal) modal.classList.add("show");
  resetInputs();
  renderTradeList();
  renderDailySummary();
  renderFavoritesDropdown();
}

function closeModal(){
  const modal = document.getElementById("modal");
  if(modal) modal.classList.remove("show");
}

function saveTrade(){
  const symEl = document.getElementById("symbolSelect");
  const inputSym = document.getElementById("inputSymbol");
  const pnlEl = document.getElementById("inputPnl");
  const notesEl = document.getElementById("inputNotes");
  const srcType = document.getElementById("inputSourceType");
  const srcProvider = document.getElementById("inputSourceProvider");

  const sym = (symEl && symEl.value) || (inputSym && inputSym.value) || "";
  const pnl = parseFloat((pnlEl && pnlEl.value) || 0);
  const notes = (notesEl && notesEl.value) || "";
  let source = "Self";
  if(srcType && srcType.value === "Signal" && srcProvider && srcProvider.value) source = srcProvider.value;

  if(!sym){ alert("Enter symbol"); return; }
  if(!selectedResult){ alert("Select result (Win/Loss/BE)"); return; }

  if(editingId){
    trades = trades.map(t => t.id === editingId ? { ...t, symbol: sym, pnl, notes, result: selectedResult, source } : t);
    showToast("Trade updated");
    editingId = null;
  } else {
    trades.push({ id: Date.now().toString(), date: selectedDate, symbol: sym, pnl, notes, result: selectedResult, source });
    showToast("Trade saved");
  }

  localStorage.setItem("journal", JSON.stringify(trades));
  renderTradeList();
  renderCalendar();
  renderDailySummary();
  resetInputs();
}

/* ================= Export / Import ================= */
function exportCSV(){
  if(!trades || !trades.length){ showToast("No trades to export"); return; }
  const headers = ["id","date","symbol","result","pnl","notes","source"];
  const rows = trades.map(t => headers.map(h => {
    let v = t[h]==null ? "" : String(t[h]).replace(/"/g,'""');
    return `"${v}"`;
  }).join(","));
  const csv = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "journal_export.csv";
  a.click();
  URL.revokeObjectURL(url);
  showToast("CSV exported");
}

function exportJSON(){
  if(!trades || !trades.length){ showToast("No trades to export"); return; }
  const blob = new Blob([JSON.stringify(trades, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "journal_export.json";
  a.click();
  URL.revokeObjectURL(url);
  showToast("JSON exported");
}

function importJSON(input){
  const file = input.files && input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const obj = JSON.parse(e.target.result);
      if(!Array.isArray(obj)) { alert("Invalid JSON file: expected an array of trades."); return; }
      // Replace existing trades with imported (user asked simple import)
      trades = obj.map(t => {
        // ensure required fields exist
        return {
          id: t.id ? String(t.id) : Date.now().toString() + Math.random().toString(36).slice(2,8),
          date: t.date || formatDate(new Date()),
          symbol: t.symbol || "NA",
          result: t.result || "be",
          pnl: Number(t.pnl) || 0,
          notes: t.notes || "",
          source: t.source || "Self"
        };
      });
      localStorage.setItem("journal", JSON.stringify(trades));
      renderCalendar();
      showToast("JSON imported");
    } catch(err){
      alert("Failed to import JSON: " + err.message);
    } finally {
      input.value = "";
    }
  };
  reader.readAsText(file);
}

/* ================= Render trade list / summary ================= */
function renderTradeList(){
  const list = document.getElementById("tradeList");
  if(!list) return;
  list.innerHTML = "";
  const dayTrades = trades.filter(t => t.date === selectedDate);
  if(dayTrades.length === 0){
    list.innerHTML = `<p class="muted">No trades yet.</p>`;
    return;
  }
  dayTrades.forEach(t => {
    const div = document.createElement("div");
    div.className = "trade-row";
    div.innerHTML = `
      <div class="trade-info">${t.symbol} • ${t.result.toUpperCase()} • ${t.pnl>=0?"+":""}${Number(t.pnl).toFixed(2)} • <span class="small-muted">${t.source||"Self"}</span></div>
      <div class="muted" style="margin-top:6px">${t.notes || ""}</div>
      <div class="trade-actions">
        <button class="btn" onclick="editTrade('${t.id}')">Edit</button>
        <button class="btn" onclick="deleteTrade('${t.id}')">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function renderDailySummary(){
  const summary = document.getElementById("dailySummary");
  if(!summary) return;
  const dayTrades = trades.filter(t => t.date === selectedDate);
  if(dayTrades.length === 0){ summary.className = "daily-summary neutral"; summary.innerText = "No trades yet."; return; }
  const pnl = dayTrades.reduce((a,t) => a + Number(t.pnl), 0);
  const wins = dayTrades.filter(t => t.result === "win").length;
  const losses = dayTrades.filter(t => t.result === "loss").length;
  const nonBeTrades = wins + losses;
  const rate = nonBeTrades ? Math.round((wins / nonBeTrades) * 100) : 0;
  let cls = "neutral";
  if(pnl > 0) cls = "profit";
  else if(pnl < 0) cls = "loss";
  summary.className = "daily-summary " + cls;
  summary.innerHTML = `<b>${dayTrades.length} trade(s)</b> • Total P&L: <b>${pnl>=0?"+":""}${pnl.toFixed(2)}</b> • Win Rate: <b>${rate}%</b>`;
}

function editTrade(id){
  const t = trades.find(x => x.id === id);
  if(!t) return;
  editingId = id;
  const inputSymbol = document.getElementById("inputSymbol");
  const symbolSelect = document.getElementById("symbolSelect");
  const inputPnl = document.getElementById("inputPnl");
  const inputNotes = document.getElementById("inputNotes");
  const srcType = document.getElementById("inputSourceType");
  const srcProvider = document.getElementById("inputSourceProvider");
  if(inputSymbol) inputSymbol.value = t.symbol;
  if(symbolSelect) symbolSelect.value = "";
  if(inputPnl) inputPnl.value = t.pnl;
  if(inputNotes) inputNotes.value = t.notes;
  if(srcType && srcProvider){
    if(t.source && t.source !== "Self"){
      srcType.value = "Signal";
      srcProvider.style.display = "block";
      srcProvider.value = t.source;
    } else {
      srcType.value = "Self";
      srcProvider.style.display = "none";
      srcProvider.value = "";
    }
  }
  selectedResult = t.result;
  highlightResult();
  selectedDate = t.date;
  const md = document.getElementById("modalDate");
  if(md) md.innerText = t.date;
  const modal = document.getElementById("modal");
  if(modal) modal.classList.add("show");
  renderTradeList();
  renderDailySummary();
}

function deleteTrade(id){
  if(!confirm("Delete this trade?")) return;
  trades = trades.filter(t => t.id !== id);
  localStorage.setItem("journal", JSON.stringify(trades));
  renderTradeList();
  renderCalendar();
  renderDailySummary();
  showToast("Trade deleted");
}

/* ================= Helpers / UI utils ================= */
function toggleDarkMode(){
  document.body.classList.toggle("dark");
}

function resetInputs(){
  const symbolSelect = document.getElementById("symbolSelect");
  const inputSymbol = document.getElementById("inputSymbol");
  const inputPnl = document.getElementById("inputPnl");
  const inputNotes = document.getElementById("inputNotes");
  const srcType = document.getElementById("inputSourceType");
  const srcProvider = document.getElementById("inputSourceProvider");
  if(symbolSelect) symbolSelect.value = "";
  if(inputSymbol) inputSymbol.value = "";
  if(inputPnl) inputPnl.value = "";
  if(inputNotes) inputNotes.value = "";
  if(srcType) srcType.value = "Self";
  if(srcProvider) { srcProvider.value = ""; srcProvider.style.display = "none"; }
  selectedResult = null;
  editingId = null;
  highlightResult();
}

function highlightResult(){
  document.querySelectorAll("#resultBtns .btn.result").forEach(btn => {
    btn.classList.remove("active");
    if(btn.dataset && btn.dataset.result === selectedResult) btn.classList.add("active");
  });
}

function showToast(msg){
  const t = document.getElementById("toast");
  if(!t) return;
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display = "none", 1600);
}

/* ================= Navigation ================= */
function prevMonth(){ currentMonth--; if(currentMonth < 0){ currentMonth = 11; currentYear--; } renderCalendar(); }
function nextMonth(){ currentMonth++; if(currentMonth > 11){ currentMonth = 0; currentYear++; } renderCalendar(); }

/* ================= Gemini Integration ================= */
/* Your Gemini API key (if you want to use it) */
const GEMINI_API_KEY = "AIzaSyAOxXQetv8Dz4wcXBRXrE1JrwEmWnIU3bk";

/* Helper to escape HTML */
function escapeHtml(text) {
  if(!text) return "";
  return text.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* Local fallback report generator (now includes ROI and goal analysis) */
function localWeeklyReport(weeklyTrades, weekKey) {
  const pnl = weeklyTrades.reduce((a,t) => a + Number(t.pnl), 0);
  const wins = weeklyTrades.filter(t => t.result === "win").length;
  const losses = weeklyTrades.filter(t => t.result === "loss").length;
  const total = weeklyTrades.length;
  const nonBeTrades = wins + losses;
  const rate = nonBeTrades ? Math.round(wins/nonBeTrades*100) : 0;

  const symbolCount = {};
  weeklyTrades.forEach(t => { symbolCount[t.symbol] = (symbolCount[t.symbol] || 0) + 1; });
  const topSymbol = Object.entries(symbolCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—";

  const cap = Number(weeklyCapital[weekKey] || 0);
  const roi = cap > 0 ? (pnl / cap) * 100 : null;

  let suggestion = "Focus on consistency.";
  if (rate > 70) suggestion = "Great performance! Keep managing risk well.";
  else if (rate < 40) suggestion = "Review losing trades and tighten risk management.";
  else if (pnl < 0) suggestion = "Loss this week; consider reducing position sizes and avoid revenge trading.";
  else suggestion = "Decent week — refine trade selection and keep a watch on top symbols.";

  return {
    title: "Local Weekly Report",
    html: `<b>Local Weekly Report:</b><br>
      Trades: ${total} (${wins} wins, ${losses} losses)<br>
      PnL: ${pnl>=0?'+':''}${pnl.toFixed(2)}<br>
      ROI: ${roi !== null ? roi.toFixed(1)+'%' : 'N/A'}<br>
      Winrate: ${rate}%<br>
      Top Symbol: ${escapeHtml(topSymbol)}<br>
      Suggestion: ${escapeHtml(suggestion)}`
  };
}

function localWeeklyGoalAnalysis(weeklyTrades, weekKey) {
  const pnl = weeklyTrades.reduce((a,t) => a + Number(t.pnl), 0);
  const goal = Number(weeklyGoals[weekKey] || 0);
  const cap = Number(weeklyCapital[weekKey] || 0);
  const roi = cap > 0 ? (pnl / cap) * 100 : null;
  let status = "No goal set.";
  if(goal > 0){
    if(pnl >= goal) status = `Goal achieved: +${pnl.toFixed(2)} vs goal ${goal.toFixed(2)}. Well done.`;
    else if(pnl > 0) status = `Partial progress: +${pnl.toFixed(2)} of ${goal.toFixed(2)} goal.`;
    else status = `Below target: ${pnl.toFixed(2)} vs goal ${goal.toFixed(2)}.`;
  }
  const advice = goal > 0 ? (pnl >= goal ? "Maintain risk and avoid overtrading." : "Focus on higher probability setups and review losses.") : "Set a weekly goal to track progress.";

  return {
    title: "Local Weekly Goal Analysis",
    html: `<b>Local Weekly Goal Analysis:</b><br>
      Weekly PnL: ${pnl>=0?'+':''}${pnl.toFixed(2)}<br>
      Goal: ${goal > 0 ? goal.toFixed(2) : "N/A"}<br>
      Status: ${escapeHtml(status)}<br>
      ROI: ${roi !== null ? roi.toFixed(1) + '%' : "N/A"}<br>
      Recommendation: ${escapeHtml(advice)}`
  };
}

// Format date to YYYY-MM-DD (safe)
function formatDate(d) {
  if(!d) return "";
  if(typeof d === "string") return d;
  return d.toISOString().split("T")[0];
}

// Get all trades between two dates (string-based compare to avoid timezone issues)
function getWeeklyTrades(startDate, endDate) {
  const start = formatDate(new Date(startDate));
  const end = formatDate(new Date(endDate));

  return trades.filter(t => {
    return t.date >= start && t.date <= end;
  });
}

// Robust extractor for Gemini response (tries common shapes)
function extractTextFromGeminiResponse(data){
  if(!data) return "";
  try {
    if (data.candidates && data.candidates[0]) {
      const cont = data.candidates[0].content;
      if (Array.isArray(cont)) {
        let text = cont.map(block=>{
          if (block.parts && Array.isArray(block.parts)) return block.parts.map(p=>p.text||"").join("");
          if (block.text) return block.text;
          return "";
        }).join("\n\n");
        if(text && text.trim()) return text;
      } else if (cont && cont.parts && cont.parts[0] && cont.parts[0].text) {
        return cont.parts[0].text;
      }
    }
  } catch(e){ /* ignore */ }

  try {
    if (data.output && Array.isArray(data.output) && data.output[0] && data.output[0].content) {
      const cont = data.output[0].content;
      if (Array.isArray(cont)) return cont.map(c=>c.text||"").join("\n");
      if (typeof cont === "string") return cont;
    }
  } catch(e){ /* ignore */ }

  try {
    if(data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content[0] && data.candidates[0].content[0].text){
      return data.candidates[0].content[0].text;
    }
  } catch(e){}

  try{
    if(data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content){
      const cont = data.choices[0].message.content;
      if(typeof cont === "string") return cont;
      if(Array.isArray(cont)) return cont.map(c=>c.text||"").join("\n");
    }
  }catch(e){}

  function findFirstString(obj){
    if(!obj) return null;
    if(typeof obj === "string") return obj;
    if(Array.isArray(obj)){
      for(const it of obj){
        const s = findFirstString(it);
        if(s) return s;
      }
    } else if(typeof obj === "object"){
      for(const k in obj){
        const s = findFirstString(obj[k]);
        if(s) return s;
      }
    }
    return null;
  }
  return findFirstString(data) || "";
}

// Generate Gemini weekly report (if key available) else local fallback
async function generateGeminiWeeklyReport(weekStart, weekEnd, shortSummary, weekKey) {
  if (!weekStart || !weekEnd) {
    if (currentWeekRange && currentWeekRange.start && currentWeekRange.end) {
      weekStart = currentWeekRange.start;
      weekEnd = currentWeekRange.end;
      shortSummary = currentWeekRange.summary;
      weekKey = currentWeekRange.weekKey;
    } else if (weekKey) {
      // we'll derive trades by weekKey below
    } else {
      alert("⚠️ Missing week range. Open a weekly modal or click the week on the calendar first.");
      return;
    }
  }

  let weeklyTrades = [];

  if (weekStart && weekEnd) {
    const s = new Date(formatDate(weekStart) + "T00:00:00");
    const e = new Date(formatDate(weekEnd) + "T00:00:00");
    weeklyTrades = getWeeklyTrades(s, e);
  } else if (weekKey) {
    const [y, w] = weekKey.split("-W");
    weeklyTrades = trades.filter(t => {
      const d = new Date(t.date + "T00:00:00");
      const [yy, ww] = getWeekNumber(d);
      return String(yy) === y && String(ww).padStart(2,"0") === w;
    });
  }

  if (!weeklyTrades || weeklyTrades.length === 0) {
    alert("⚠️ No trades found for this week.");
    return;
  }

  showToast("Generating Gemini report...");

  const pnl = weeklyTrades.reduce((a,t)=>a+Number(t.pnl),0);
  const wins = weeklyTrades.filter(t=>t.result==="win").length;
  const losses = weeklyTrades.filter(t=>t.result==="loss").length;
  const total = weeklyTrades.length;
  const nonBeTrades = wins + losses;
  const rate = nonBeTrades ? Math.round(wins/nonBeTrades*100) : 0;
  const short = shortSummary || `Trades: ${total}, PnL ${(pnl>=0?"+":"")+pnl.toFixed(2)}, WR ${rate}%`;

  const cap = Number(weeklyCapital[weekKey] || 0);
  const roi = cap > 0 ? (pnl / cap) * 100 : null;

  // if no API key present, fall back to local
  if(!GEMINI_API_KEY){
    const local = localWeeklyReport(weeklyTrades, weekKey);
    document.getElementById("aiWeeklyReport").innerHTML = local.html;
    showToast("Displayed local report (Gemini API key not set).");
    return;
  }

  const endpoint = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  const body = {
    contents: [
      {
        role: "user",
        parts: [
          {
            text: `You are a concise trading analyst. Here is the weekly trading data:\n\nSummary: ${short}\nWeekly P&L: ${(pnl>=0?"+":"")+pnl.toFixed(2)}\nStarting Capital: ${cap || "N/A"}\nROI: ${roi !== null ? roi.toFixed(1)+"%" : "N/A"}\n\nTrades:\n${JSON.stringify(weeklyTrades,null,2)}\n\nPlease generate a short professional report (3-5 short paragraphs) with: key insights, strengths, weaknesses, ROI analysis (efficiency of capital usage), and 3 quick action items.`
          }
        ]
      }
    ]
  };

  try {
    const resp = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await resp.json();
    console.log("Gemini raw response:", data);

    let textOutput = extractTextFromGeminiResponse(data);
    if(!textOutput || textOutput.trim()===""){
      const local = localWeeklyReport(weeklyTrades, weekKey);
      textOutput = local.html.replace(/<br>/g,"\n");
    }

    document.getElementById("aiWeeklyReport").innerHTML = escapeHtml(textOutput).replace(/\n/g,"<br>");
    showToast("Gemini report displayed");
  } catch (err) {
    console.error("Gemini API error:", err);
    const local = localWeeklyReport(weeklyTrades, weekKey);
    document.getElementById("aiWeeklyReport").innerHTML = local.html;
    alert("⚠️ Gemini API error: " + (err.message || String(err)) + "\n\nShowing local summary instead.");
  }
}

// Gemini goal analysis (uses weeklyGoals)
async function generateGeminiGoalAnalysis(weekStart, weekEnd, shortSummary, weekKey) {
  if (!weekStart || !weekEnd) {
    if (currentWeekRange && currentWeekRange.start && currentWeekRange.end) {
      weekStart = currentWeekRange.start;
      weekEnd = currentWeekRange.end;
      shortSummary = currentWeekRange.summary;
      weekKey = currentWeekRange.weekKey;
    } else {
      alert("⚠️ Missing week range. Open a weekly modal or click the week on the calendar first.");
      return;
    }
  }

  const weeklyTrades = getWeeklyTrades(weekStart, weekEnd);
  if (!weeklyTrades || weeklyTrades.length === 0) {
    alert("⚠️ No trades found for this week.");
    return;
  }

  showToast("Generating Gemini goal analysis...");

  const pnl = weeklyTrades.reduce((a,t)=>a+Number(t.pnl),0);
  const goal = Number(weeklyGoals[weekKey] || 0);
  const cap = Number(weeklyCapital[weekKey] || 0);
  const roi = cap > 0 ? (pnl / cap) * 100 : null;

  if(!GEMINI_API_KEY){
    const local = localWeeklyGoalAnalysis(weeklyTrades, weekKey);
    document.getElementById("aiWeeklyReport").innerHTML = local.html;
    showToast("Displayed local goal analysis (Gemini API key not set).");
    return;
  }

  const endpoint = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  const body = {
    contents: [
      {
        role: "user",
        parts: [
          {
            text: `You are an objective trading coach. Here is the weekly data:\n\nWeekly PnL: ${(pnl>=0?"+":"")+pnl.toFixed(2)}\nWeekly Goal: ${goal || "N/A"}\nStarting Capital: ${cap || "N/A"}\nROI: ${roi !== null ? roi.toFixed(1)+"%" : "N/A"}\nTrades:\n${JSON.stringify(weeklyTrades,null,2)}\n\nPlease analyze whether the weekly goal was met, why/why not, high-level reasons (trade selection, risk, position sizing), and provide 3 practical adjustments to improve goal attainment next week. Keep concise.`
          }
        ]
      }
    ]
  };

  try {
    const resp = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await resp.json();
    let textOutput = extractTextFromGeminiResponse(data);
    if(!textOutput || textOutput.trim()===""){
      const local = localWeeklyGoalAnalysis(weeklyTrades, weekKey);
      textOutput = local.html.replace(/<br>/g,"\n");
    }
    document.getElementById("aiWeeklyReport").innerHTML = escapeHtml(textOutput).replace(/\n/g,"<br>");
    showToast("Gemini goal analysis displayed");
  } catch (err) {
    console.error("Gemini API error:", err);
    const local = localWeeklyGoalAnalysis(weeklyTrades, weekKey);
    document.getElementById("aiWeeklyReport").innerHTML = local.html;
    alert("⚠️ Gemini API error: " + (err.message || String(err)) + "\n\nShowing local analysis instead.");
  }
}

/* ================= Analytics utilities ================= */
function computeAnalytics(allTrades) {
  // Sort by date then by id (stable)
  const sorted = [...allTrades].sort((a,b) => {
    if(a.date === b.date) return (a.id||"").localeCompare(b.id||"");
    return a.date.localeCompare(b.date);
  });

  // Cumulative equity by trade
  let cum = 0;
  let peak = -Infinity;
  let maxDD = 0;
  const equity = [];
  for(const t of sorted){
    cum += Number(t.pnl);
    equity.push(cum);
    if(cum > peak) peak = cum;
    const dd = peak - cum;
    if(dd > maxDD) maxDD = dd;
  }

  // Profit factor: sum(win pnl) / abs(sum(loss pnl))
  let winsSum = 0, lossSum = 0;
  for(const t of allTrades){
    const v = Number(t.pnl);
    if(t.result === "win") winsSum += v;
    else if(t.result === "loss") lossSum += v;
  }
  const profitFactor = lossSum === 0 ? (winsSum > 0 ? Infinity : 0) : (winsSum / Math.abs(lossSum));

  // Longest streaks (by sequence of trades, not grouped by day)
  let longestWin = 0, longestLoss = 0;
  let curWin = 0, curLoss = 0;
  for(const t of sorted){
    if(t.result === "win"){
      curWin++; longestWin = Math.max(longestWin, curWin);
      curLoss = 0;
    } else if(t.result === "loss"){
      curLoss++; longestLoss = Math.max(longestLoss, curLoss);
      curWin = 0;
    } else {
      // break-even resets both streaks
      curWin = 0; curLoss = 0;
    }
  }

  return {
    maxDrawdown: maxDD || 0,
    profitFactor: profitFactor,
    longestWinStreak: longestWin,
    longestLossStreak: longestLoss,
    equitySeries: equity
  };
}

/* ================= Charts rendering ================= */
function aggregateByDateAllTrades() {
  // produce sorted dates and cumulative pnl by date
  const dates = Array.from(new Set(trades.map(t => t.date))).sort();
  const labels = [];
  const values = [];
  let cum = 0;
  dates.forEach(d => {
    const todays = trades.filter(t => t.date === d);
    const sumToday = todays.reduce((a,b)=>a+Number(b.pnl),0);
    cum += sumToday;
    labels.push(d);
    values.push(cum);
  });
  return { labels, values };
}

function buildResultsDistribution() {
  const counts = { win:0, loss:0, be:0 };
  trades.forEach(t => {
    if(t.result === "win") counts.win++;
    else if(t.result === "loss") counts.loss++;
    else counts.be++;
  });
  return counts;
}

function buildHistogramData(bins = 12) {
  const pnls = trades.map(t => Number(t.pnl)).sort((a,b)=>a-b);
  if(pnls.length === 0) return { labels: [], data: [] };
  const min = pnls[0], max = pnls[pnls.length-1];
  const range = max - min || 1;
  const binSize = range / bins;
  const counts = new Array(bins).fill(0);
  pnls.forEach(v => {
    const idx = Math.min(bins-1, Math.floor((v - min) / binSize));
    counts[idx]++; 
  });
  const labels = counts.map((_,i) => {
    const a = (min + binSize*i);
    const b = (min + binSize*(i+1));
    return `${a.toFixed(2)} → ${b.toFixed(2)}`;
  });
  return { labels, data: counts };
}

function buildSourceCounts(limit = 12) {
  const map = {};
  trades.forEach(t => { const s = t.source || "Self"; map[s] = (map[s] || 0) + 1; });
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  const labels = entries.slice(0,limit).map(e=>e[0]);
  const data = entries.slice(0,limit).map(e=>e[1]);
  return { labels, data };
}

function renderCharts() {
  // load Chart.js if not loaded
  if (typeof Chart === "undefined") {
    // Chart.js CDN loaded dynamically
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/chart.js";
    s.onload = () => { renderCharts(); };
    document.head.appendChild(s);
    return;
  }

  // Equity
  const eq = aggregateByDateAllTrades();
  const res = buildResultsDistribution();
  const hist = buildHistogramData(12);
  const src = buildSourceCounts(12);

  // Equity chart
  const eqEl = document.getElementById("equityChart");
  if(eqEl){
    const ctxEq = eqEl.getContext("2d");
    if(equityChart) equityChart.destroy();
    equityChart = new Chart(ctxEq, {
      type: "line",
      data: {
        labels: eq.labels,
        datasets: [{
          label: "Cumulative P&L",
          data: eq.values,
          fill: false,
          tension: 0.2,
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true },
          y: { display: true }
        }
      }
    });
  }

  // Pie chart (results distribution)
  const pieEl = document.getElementById("pieChart");
  if(pieEl){
    const ctxPie = pieEl.getContext("2d");
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(ctxPie, {
      type: "pie",
      data: {
        labels: ["Wins","Losses","Break-even"],
        datasets: [{
          data: [res.win, res.loss, res.be],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "bottom" } }
      }
    });
  }

  // Histogram chart
  const histEl = document.getElementById("histChart");
  if(histEl){
    const ctxHist = histEl.getContext("2d");
    if(histChart) histChart.destroy();
    histChart = new Chart(ctxHist, {
      type: "bar",
      data: {
        labels: hist.labels,
        datasets: [{
          label: "Count",
          data: hist.data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true, ticks: { maxRotation: 30, minRotation: 30 } },
          y: { display: true }
        }
      }
    });
  }

  // Source distribution chart
  const srcEl = document.getElementById("sourceChart");
  if(srcEl){
    const ctxSrc = srcEl.getContext("2d");
    if(sourceChart) sourceChart.destroy();
    sourceChart = new Chart(ctxSrc, {
      type: "bar",
      data: {
        labels: src.labels,
        datasets: [{
          label: "Trades",
          data: src.data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true },
          y: { display: true }
        }
      }
    });
  }
}

/* ================= Init / Event listeners ================= */
document.addEventListener("DOMContentLoaded", () => {
  // result toggle buttons
  document.querySelectorAll("#resultBtns .btn.result").forEach(btn => {
    btn.addEventListener("click", () => {
      selectedResult = btn.dataset.result;
      highlightResult();
    });
  });

  // Enter to save from PnL input
  const pnlEl = document.getElementById("inputPnl");
  if(pnlEl){
    pnlEl.addEventListener("keypress", (e) => {
      if(e.key === "Enter"){ e.preventDefault(); saveTrade(); }
    });
  }

  // wire source selector change handler
  const srcType = document.getElementById("inputSourceType");
  if(srcType) srcType.addEventListener("change", onSourceTypeChange);

  // initial renders
  renderFavoritesDropdown();
  renderWeekdays();
  renderCalendar();
  // default tab is journal
  switchTab("journal");
});
</script>
</body>
</html>
